<!doctype html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content="core. - Выбор тарифа" />
    <title>Выбор тарифа - core.</title>

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link rel="preload" href="css/tariff.css" as="style" />
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;800;900&family=Caveat:wght@700&display=swap"
    />
    <link rel="icon" href="favicon.png" type="image/png" />
    <link rel="stylesheet" href="css/index.css" />

    <!-- Yandex.Metrika counter -->
    <script type="text/javascript">
      (function (m, e, t, r, i, k, a) {
        m[i] =
          m[i] ||
          function () {
            (m[i].a = m[i].a || []).push(arguments);
          };
        m[i].l = 1 * new Date();
        for (var j = 0; j < document.scripts.length; j++) {
          if (document.scripts[j].src === r) {
            return;
          }
        }
        ((k = e.createElement(t)),
          (a = e.getElementsByTagName(t)[0]),
          (k.async = 1),
          (k.src = r),
          a.parentNode.insertBefore(k, a));
      })(
        window,
        document,
        "script",
        "https://mc.yandex.ru/metrika/tag.js?id=107010402",
        "ym",
      );
      ym(107010402, "init", {
        ssr: true,
        webvisor: true,
        clickmap: true,
        ecommerce: "dataLayer",
        referrer: document.referrer,
        url: location.href,
        accurateTrackBounce: true,
        trackLinks: true,
      });
    </script>
    <noscript
      ><div>
        <img
          src="https://mc.yandex.ru/watch/107010402"
          style="position: absolute; left: -9999px"
          alt=""
        /></div
    ></noscript>
    <!-- /Yandex.Metrika counter -->

    <style>
      /* Твои стили без изменений */
      .tariff-price {
        font-size: 2.8rem;
        font-weight: 900;
        margin-top: 5px;
        color: var(--black);
        display: flex;
        align-items: baseline;
        justify-content: center;
      }
      .tariff-price span {
        font-size: 1.5rem;
        font-weight: 600;
        margin-left: 5px;
        color: var(--gray-dark);
      }
      button.btn-tariff {
        border: none;
        cursor: pointer;
        width: 100%;
        font-family: inherit;
        font-size: 1rem;
        position: relative;
        z-index: 10;
      }
      .old-price {
        text-decoration: line-through;
        color: #a0a0a0;
        font-size: 1.2rem;
        display: block;
        margin-bottom: -5px;
        font-weight: 500;
        text-align: center;
      }
      .mentor .old-price {
        color: rgba(255, 255, 255, 0.5);
      }
      .mentor .tariff-price {
        color: #fff;
      }

      /* Стили для модального окна, которое будет содержать кнопки оплаты */
      .payment-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.75);
        backdrop-filter: blur(10px);
        z-index: 999999;
        justify-content: center;
        align-items: center;
        opacity: 0;
        transition: opacity 0.3s ease;
        padding: 20px;
      }
      .payment-modal.show {
        display: flex;
        opacity: 1;
      }
      .payment-modal-content {
        background: #ffffff;
        padding: 30px;
        border-radius: 24px;
        width: 100%;
        max-width: 400px;
        text-align: center;
        color: #000;
      }
      .close-btn {
        position: absolute;
        top: 15px;
        right: 15px;
        background: #f0f0f0;
        border: none;
        width: 36px;
        height: 36px;
        border-radius: 50%;
        font-size: 18px;
        font-weight: 600;
        cursor: pointer;
      }
      #paymentContainer {
        min-height: 100px;
        display: flex;
        flex-direction: column;
        justify-content: center;
      }
    </style>
  </head>
  <body>
    <canvas id="noise-canvas" style="pointer-events: none"></canvas>

    <!-- МОДАЛЬНОЕ ОКНО ДЛЯ ВИДЖЕТОВ ОПЛАТЫ -->
    <div id="payment-modal" class="payment-modal">
      <div class="payment-modal-content">
        <button class="close-btn" onclick="closeModal()">✕</button>
        <h3 id="modal-tariff-name">Оформление заказа</h3>
        <p id="modal-tariff-price" style="color: #666; margin-bottom: 20px">
          0 ₽
        </p>
        <div id="paymentContainer"></div>
      </div>
    </div>

    <nav class="navbar">
      <!-- ... Твоя навигация ... -->
    </nav>
    <main
      style="
        padding-top: 100px;
        padding-bottom: 60px;
        min-height: 80vh;
        display: flex;
        align-items: center;
      "
    >
      <section class="new-section" id="tariffs" style="width: 100%; padding: 0">
        <!-- ... Вся твоя HTML-верстка тарифов ... -->
      </section>
    </main>
    <footer class="site-footer reveal">
      <!-- ... Твой футер ... -->
    </footer>

    <!-- НОВЫЙ, ПРАВИЛЬНЫЙ СКРИПТ ИНТЕГРАЦИИ (ПО ДОКУМЕНТАЦИИ) -->
    <script
      src="https://integrationjs.tbank.ru/integration.js"
      onload="onPaymentIntegrationLoad()"
      async
    ></script>

    <script>
      // === 1. ГЛОБАЛЬНЫЕ ПЕРЕМЕННЫЕ ===
      const BACKEND_URL = "http://85.215.137.163:8000/api/get_payment_url"; // <-- IP ТВОЕГО СЕРВЕРА
      const paymentModal = document.getElementById("payment-modal");
      const paymentContainer = document.getElementById("paymentContainer");
      let paymentIntegration;

      // === 2. ИНИЦИАЛИЗАЦИЯ (сработает, когда integration.js загрузится) ===
      function onPaymentIntegrationLoad() {
        const initConfig = {
          terminalKey: "1771969236568",
          product: "eacq",
          features: { payment: {} },
        };

        PaymentIntegration.init(initConfig)
          .then((integration) => {
            console.log(
              "Виджет Т-Банка (integration.js) успешно инициализирован!",
            );
            paymentIntegration = integration;
          })
          .catch((error) =>
            console.error("Ошибка инициализации виджета:", error),
          );
      }

      // === 3. ВЫЗОВ ОПЛАТЫ (срабатывает по клику на твои кнопки) ===
      async function payTinkoff(amount, name) {
        if (!paymentIntegration) {
          alert("Платежный модуль еще не загружен, подождите.");
          return;
        }

        document.getElementById("modal-tariff-name").innerText = name;
        document.getElementById("modal-tariff-price").innerText =
          amount.toLocaleString("ru-RU") + " ₽";
        paymentModal.classList.add("show");
        paymentContainer.innerHTML = "Загрузка кнопок оплаты...";

        try {
          // ДОЖИДАЕМСЯ ЗАГРУЗКИ МОДУЛЯ PAYMENTS
          const paymentsModule = await paymentIntegration.payments;

          // Устанавливаем коллбэк для похода на бэкенд
          paymentsModule.setPaymentStartCallback(async () => {
            console.log("Старт платежа, обращаемся к бэкенду...");
            try {
              const response = await fetch(BACKEND_URL, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ name: name }),
              });

              if (!response.ok)
                throw new Error("Ошибка сервера: " + response.status);
              const data = await response.json();

              if (typeof ym !== "undefined") {
                ym(107010402, "reachGoal", "pay_button_click");
              }
              return data.payment_url;
            } catch (error) {
              console.error("Ошибка получения ссылки от бэкенда:", error);
              alert(
                "Не удалось создать платеж. Проверьте консоль (F12) на ошибки.",
              );
              closeModal();
            }
          });

          // Очищаем контейнер и рендерим кнопки
          paymentContainer.innerHTML = "";
          paymentsModule.render(paymentContainer);
        } catch (error) {
          console.error("Ошибка при рендере кнопок:", error);
          paymentContainer.innerHTML =
            '<p style="color:red">Ошибка загрузки виджетов.</p>';
        }
      }

      // === 4. ВСПОМОГАТЕЛЬНЫЕ ФУНКЦИИ ===
      function closeModal() {
        paymentModal.classList.remove("show");
        paymentContainer.innerHTML = "";
      }

      paymentModal.addEventListener("click", (e) => {
        if (e.target === paymentModal) closeModal();
      });

      // --- ТВОИ ОРИГИНАЛЬНЫЕ СКРИПТЫ ШУМА И АНИМАЦИИ ---
      const noiseCanvas = document.getElementById("noise-canvas");
      if (noiseCanvas) {
        const ctx = noiseCanvas.getContext("2d", { alpha: true });
        let pattern;
        const patternSize = 256;
        const resize = () => {
          noiseCanvas.width = window.innerWidth;
          noiseCanvas.height = window.innerHeight;
        };
        window.addEventListener("resize", resize);
        resize();
        const createPattern = () => {
          const tile = document.createElement("canvas");
          tile.width = patternSize;
          tile.height = patternSize;
          const tCtx = tile.getContext("2d");
          const id = tCtx.createImageData(patternSize, patternSize);
          const buffer = new Uint32Array(id.data.buffer);
          for (let i = 0; i < buffer.length; i++) {
            if (Math.random() < 0.2) {
              buffer[i] = Math.random() < 0.5 ? 0xff000000 : 0x11000000;
            }
          }
          tCtx.putImageData(id, 0, 0);
          pattern = ctx.createPattern(tile, "repeat");
        };
        createPattern();
        const loopNoise = () => {
          const xOff = Math.floor(Math.random() * patternSize);
          const yOff = Math.floor(Math.random() * patternSize);
          ctx.clearRect(0, 0, noiseCanvas.width, noiseCanvas.height);
          ctx.fillStyle = pattern;
          ctx.translate(-xOff, -yOff);
          ctx.fillRect(
            0,
            0,
            noiseCanvas.width + patternSize,
            noiseCanvas.height + patternSize,
          );
          ctx.setTransform(1, 0, 0, 1, 0, 0);
          setTimeout(() => requestAnimationFrame(loopNoise), 1000 / 15);
        };
        loopNoise();
      }

      document.addEventListener("DOMContentLoaded", () => {
        const revealObserver = new IntersectionObserver(
          (entries) => {
            entries.forEach((entry) => {
              if (entry.isIntersecting) {
                entry.target.classList.add("reveal-active");
              }
            });
          },
          { threshold: 0.1 },
        );
        document
          .querySelectorAll(".reveal, .stagger-item")
          .forEach((t) => revealObserver.observe(t));
      });
    </script>
  </body>
</html>
